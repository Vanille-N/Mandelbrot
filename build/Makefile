CXX = g++
CXXFLAGS = -Wfatal-errors -Wall -Wextra -Wpedantic -Wconversion -Wshadow

BIN = mandelbrot
SRC = ../src
TARGET = $(SRC)/obj

# List of all .cpp source files.
CPPS = $(wildcard $(SRC)/*.cpp)

# All .o files go to target dir.
OBJ = $(CPPS:$(SRC)/%.cpp=$(TARGET)/%.o)
# Gcc/Clang will create these .d files containing dependencies.
DEP = $(OBJ:%.o=%.d)

# Actual target of the binary - depends on all .o files.
$(BIN) : $(OBJ)
	$(CXX) $(CXXFLAGS) $^ -o $@

$(TARGET) :
	mkdir -p $(TARGET)

# Include all .d files
-include $(DEP)

# objs require only that target dir exists
$(OBJ) : | $(TARGET)

# Build target for every single object file.
# The potential dependency on header files is covered
# by calling `-include $(DEP)`.
$(TARGET)/%.o : $(SRC)/%.cpp
	$(CXX) $(CXXFLAGS) -MMD -c $< -o $@

.PHONY : clean
clean :
	# Remove all autogenerated files
	-rm $(BIN) $(OBJ) $(DEP)
	-rmdir $(TARGET)
